#!/bin/bash
# SUPER FAST - Just deploy without rebuilding (30 seconds)
# Use this if API was already built once

echo "=========================================="
echo "⚡ Super Fast Deployment (30 seconds)"
echo "=========================================="
echo ""

EC2_IP="34.227.111.143"
SSH_KEY="cloudshell-key.pem"

echo "Checking if API binary already exists on EC2..."
EXISTING=$(ssh -i ~/$SSH_KEY -o StrictHostKeyChecking=no ec2-user@$EC2_IP "ls -la /opt/pgworld/pgworld-api 2>/dev/null" 2>&1)

if [[ $EXISTING == *"pgworld-api"* ]]; then
    echo "✅ API binary exists"
    echo ""
    echo "Quick restart..."
    
    ssh -i ~/$SSH_KEY -o StrictHostKeyChecking=no ec2-user@$EC2_IP << 'ENDSSH' 2>&1 | grep -v "Pseudo"
    sudo systemctl stop pgworld-api 2>/dev/null
    sudo systemctl daemon-reload
    sudo systemctl start pgworld-api
    sleep 3
    sudo systemctl status pgworld-api --no-pager | head -10
ENDSSH
    
    echo ""
    echo "Testing..."
    sleep 2
    RESPONSE=$(curl -s http://$EC2_IP:8080/health)
    
    if [[ $RESPONSE == *"healthy"* ]]; then
        echo "✅✅✅ API IS LIVE! ✅✅✅"
        echo "Response: $RESPONSE"
        echo ""
        echo "URL: http://$EC2_IP:8080/health"
    else
        echo "⚠️ API not responding: $RESPONSE"
        echo ""
        echo "Checking logs..."
        ssh -i ~/$SSH_KEY -o StrictHostKeyChecking=no ec2-user@$EC2_IP "sudo journalctl -u pgworld-api -n 20 --no-pager" 2>&1 | grep -v "Pseudo"
    fi
else
    echo "❌ API not deployed yet"
    echo ""
    echo "You need to run the full deployment first:"
    echo "  bash FAST_DEPLOY.txt"
fi

echo ""
echo "=========================================="

